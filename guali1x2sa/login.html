<!DOCTYPE html>
<html>
<head>
  <title>管理员登录</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 500px; margin: 50px auto; padding: 20px; }
    .container { padding: 20px; border: 1px solid #ccc; border-radius: 5px; }
    .form-group { margin: 15px 0; }
    label { display: block; margin-bottom: 5px; }
    input { width: 100%; padding: 8px; box-sizing: border-box; }
    button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background: #0056b3; }
    .error { color: red; margin: 10px 0; }
    .loading { color: #666; margin: 10px 0; }
  </style>
</head>
<body>
  <div class="container">
    <h2>管理员登录</h2>
    <div class="form-group">
      <label>访问链接：</label>
      <input type="text" id="workerUrl" placeholder="例如：https://xnss.fun/1" value="https://xnss.fun/1">
    </div>
    <div class="form-group">
      <label>管理密钥：</label>
      <input type="password" id="adminKey" placeholder="输入管理密钥">
    </div>
    <button onclick="login()">登录</button>
    <div id="loginStatus" class="error"></div>
  </div>

  <script>
async function login() {
    const workerUrl = document.getElementById("workerUrl").value.trim();
    const adminKey = document.getElementById("adminKey").value.trim();
    const statusEl = document.getElementById("loginStatus");
    
    statusEl.textContent = "";
    
    if (!workerUrl) {
        statusEl.textContent = "请输入访问链接";
        return;
    }
    
    if (!adminKey) {
        statusEl.textContent = "请输入管理密钥";
        return;
    }
    
    try {
        new URL(workerUrl);
    } catch (e) {
        statusEl.textContent = "请输入有效的URL";
        return;
    }
    
    statusEl.textContent = "正在验证...";
    statusEl.className = "loading";
    
    try {
        // 发送验证请求 - 使用POST方法进行严格验证
        const response = await fetch(workerUrl, {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${adminKey}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ action: "validate" }),
            timeout: 5000 // 5秒超时
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`验证失败: ${errorText || response.statusText}`);
        }
        
        // 验证响应内容
        const result = await response.json();
        if (!result.success) {
            throw new Error(`验证失败: ${result.message || '未知错误'}`);
        }
        
        localStorage.setItem("workerUrl", workerUrl);
        localStorage.setItem("adminKey", adminKey);
        window.location.href = "admin.html";
        
    } catch (e) {
        statusEl.textContent = `验证失败: ${e.message || '请检查链接和密钥是否正确'}`;
        statusEl.className = "error";
        console.error("登录验证错误:", e);
    }
}
  </script>
</body>
</html>
