<!DOCTYPE html>
<html lang="zh-CN">
    <script type="text/javascript"> if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) { window.location.href = "s.html"; } </script>
<head> 
    <meta charset="UTF-8" /> 
    <!--<meta http-equiv="refresh" content="0;url=https://xiaoniuss.fun">--> 
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0" /> 
    <meta http-equiv="Cache-Control" content="no-siteapp" /> 
    <meta name="apple-mobile-web-app-capable" content="yes" /> 
    <meta name="apple-touch-fullscreen" content="yes" /> 
    <meta name="apple-mobile-web-app-status-bar-style" content="black" /> 
    <meta name="full-screen" content="yes" />
    <!--UC强制全屏--> 
    <meta name="browsermode" content="application" />
    <!--UC应用模式--> 
    <meta name="x5-fullscreen" content="true" />
    <!--QQ强制全屏--> 
    <meta name="x5-page-mode" content="app" />
    <!--QQ应用模式--> 
    <title>小牛搜索- XiaoNiuss.Top</title> 
    <meta name="keywords" content="信仰圣光.一款业余的导航网站">
    <meta name="description" content="可能是最简洁的搜索导航，给你简单舒爽的搜索体验。">
    <link rel="shortcut icon" href="https://img.alicdn.com/imgextra/i3/2327995847/O1CN01fhXl2q1t3yYaZYRnO_!!2327995847.png" type="image/png" /> 
    <link rel="stylesheet" href="css/a1.css" />  
    <link rel="stylesheet" href="css/settings.css" />
    <!-- 调整脚本加载顺序：先加载核心工具类 -->
    <script src="js/a2jquery1.min.js"></script>
    <script src="js/navigation-utils.js"></script>
    <script src="js/search-utils.js"></script>
</head> 
<body>
<div id="button-container">
    <div id="menu" class="edge-button top-button">
        <span class="button-text">导航</span>
    </div>
    <div id="settings-button" class="edge-button bottom-button">
        <span class="button-text">设置</span>
    </div>
</div>
    <div class="list closed"> 
        <ul>
            <!-- 导航内容将通过JS动态生成 -->
        </ul> 
    </div> 
    <!-- <iframe src="https://sucai.xiaoniuss.top/2/" width="100%" height="100%"></iframe>-->

<!-- 修改搜索框HTML -->
<div id="search" class="s-search">
    <div id="search-list" class="hide-type-list">
        <div class="s-type">
            <span class="type-text"></span>
            <div class="s-type-list animated fadeInUp">
                <!-- 由JS动态生成 -->
            </div>
        </div>
        <!-- 搜索组由JS动态生成 -->
    </div>
    <form action="https://www.baidu.com/s?wd=" method="get" target="_blank" id="super-search-fm">
        <input type="text" id="search-text" placeholder="输入关键字搜索" style="outline:0" />
        <button type="submit"><i class="iconfont icon-xdss"></i></button>
        <ul id="ul" class="ko"></ul>
    </form>
    <input type="checkbox" id="set-search-blank" class="bubble-3" autocomplete="off" style="display:none"/>
</div>

   </div>
  </div> 
<div class="footer">
  <div class="site-info">小牛搜索-XiaoNiuSs.Top</div>
  <!--<div class="copyright">©项目中大部分素材来自网络如有侵权可联系删除</div> -->
</div>
    <script src="js/a3sousuo.js"></script> 
    <script src="js/wallpaper-config.js" defer></script>
    <script src="js/settings.js" defer></script>
    <script src="js/notices.js" defer></script>
<script>
  // 增强版数据加载逻辑：增加重试、缓存和备份机制
  (async function loadRemoteData() {
    const API_URL = 'js/shuju.js';
    const MAX_RETRIES = 2; // 最大重试次数
    let retryCount = 0;

    // 从本地缓存读取备份数据
    function getBackupData() {
      try {
        const navBackup = localStorage.getItem('navDataBackup');
        const searchBackup = localStorage.getItem('searchDataBackup');
        return {
          navigationData: navBackup ? JSON.parse(navBackup) : [],
          searchData: searchBackup ? JSON.parse(searchBackup) : []
        };
      } catch (e) {
        console.error('读取备份数据失败:', e);
        return { navigationData: [], searchData: [] };
      }
    }

    // 保存数据到本地缓存
    function saveBackupData(data) {
      try {
        if (data.navigationData) {
          localStorage.setItem('navDataBackup', JSON.stringify(data.navigationData));
        }
        if (data.searchData) {
          localStorage.setItem('searchDataBackup', JSON.stringify(data.searchData));
        }
      } catch (e) {
        console.error('保存备份数据失败:', e);
      }
    }

    // 核心加载函数（支持重试）
    async function fetchDataWithRetry() {
      try {
        // 使用AbortController设置超时
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 8000);
        
        const response = await fetch(API_URL, {
          signal: controller.signal,
          cache: 'no-store' // 禁用缓存，确保获取最新数据
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
          throw new Error(`HTTP错误: ${response.status}`);
        }
        
        const dataText = await response.text();
        console.log('远程接口原始数据:', dataText);

        // 修复JSON提取逻辑（适配workers.js返回的"const appData = ..."格式）
        const jsonStr = dataText.replace(/^const\s+appData\s*=\s*/, '').replace(/;$/, '');
        const appData = JSON.parse(jsonStr);
        
        // 严格验证数据结构
        if (!Array.isArray(appData.navigationData)) {
          throw new Error('导航数据不是数组');
        }
        if (!Array.isArray(appData.searchData)) {
          throw new Error('搜索数据不是数组');
        }
        
        // 数据清洗与格式化
        const cleanData = {
          navigationData: appData.navigationData.map(cat => ({
            title: cat.title || '未命名分类',
            links: Array.isArray(cat.links) ? cat.links.map(link => ({
              name: link.name || '未命名链接',
              url: link.url || '#',
              rel: link.rel || 'nofollow',
              target: link.target || '_blank'
            })) : []
          })),
          searchData: appData.searchData.map(cat => ({
            id: cat.id || `group-${Date.now()}`,
            title: cat.title || '未命名搜索分类',
            options: Array.isArray(cat.options) ? cat.options.map(opt => ({
              id: opt.id || `opt-${Date.now()}`,
              value: opt.value || '#',
              placeholder: opt.placeholder || '请输入搜索内容',
              name: opt.name || '未命名搜索',
              checked: opt.checked || false
            })) : []
          }))
        };
        
        // 保存备份
        saveBackupData(cleanData);
        return cleanData;
        
      } catch (error) {
        // 重试逻辑
        if (retryCount < MAX_RETRIES) {
          retryCount++;
          console.log(`数据加载失败，正在重试（${retryCount}/${MAX_RETRIES}）:`, error);
          return fetchDataWithRetry();
        }
        throw error; // 达到最大重试次数，抛出错误
      }
    }

    // 执行加载流程
    try {
      // 先尝试从远程加载
      const data = await fetchDataWithRetry();
      
      // 更新全局数据
      window.navigationData = data.navigationData;
      window.searchData = data.searchData;
      
      // 触发UI更新
      if (window.NavigationUtils) {
        NavigationUtils.updateNavigation(window.navigationData);
      }
      if (window.SearchUtils) {
        SearchUtils.renderSearchOptions();
        SearchUtils.setupEventListeners();
      }
      
    } catch (error) {
      console.error('所有加载尝试失败，使用备份数据:', error);
      
      // 尝试使用备份数据
      const backupData = getBackupData();
      window.navigationData = backupData.navigationData;
      window.searchData = backupData.searchData;
      
      // 触发UI更新
      if (window.NavigationUtils) {
        NavigationUtils.updateNavigation(window.navigationData);
      }
      if (window.SearchUtils) {
        SearchUtils.renderSearchOptions();
        SearchUtils.setupEventListeners();
      }
      
      // 显示用户提示
      const alertEl = document.createElement('div');
      alertEl.style = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);padding:10px 20px;background:#ff4444;color:white;border-radius:4px;z-index:9999';
      alertEl.textContent = '数据加载失败，已使用缓存数据';
      document.body.appendChild(alertEl);
      setTimeout(() => alertEl.remove(), 3000);
    }
  })();

  // 搜索表单提交验证
  document.getElementById('super-search-fm').addEventListener('submit', function(e) {
    // 检查是否有可用的搜索数据
    if (!window.searchData || window.searchData.length === 0) {
      e.preventDefault();
      alert('搜索数据未加载完成，请稍候再试');
      return false;
    }
    
    // 检查输入内容
    const searchText = document.getElementById('search-text').value.trim();
    if (!searchText) {
      e.preventDefault();
      document.getElementById('search-text').focus();
      return false;
    }
    
    // 动态修改表单提交地址
    const activeOption = document.querySelector('input[name="search-type"]:checked');
    if (activeOption) {
      e.preventDefault();
      const url = activeOption.value + encodeURIComponent(searchText);
      window.open(url, '_blank');
      return false;
    }
    
    return true;
  });
</script>

<!-- 外部脚本：异步加载（不阻塞，加载完成后立即执行） -->
<!-- <script src="https://dhsj.xnss.fun" async></script> -->


    <div class="bgo"></div> 
</body>

</html>



